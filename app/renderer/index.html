<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>OwnDrive Settings</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      padding: 30px;
      background: #f5f5f5;
      margin: 0;
    }

    h1 {
      color: #333;
      margin-bottom: 30px;
      font-size: 24px;
    }

    .setting {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .setting h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: #444;
      font-size: 16px;
    }

    input[type="text"] {
      width: calc(100% - 20px);
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    button {
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    button:hover {
      background: #0056b3;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .status {
      color: #666;
      font-size: 14px;
      margin-bottom: 10px;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 4px;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>OwnDrive Sync Settings</h1>

  <div class="setting">
    <h3>Firebase Configuration</h3>
    <div style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 5px; font-size: 14px; color: #666;">
        Paste entire config (optional):
      </label>
      <textarea id="configJson" placeholder='Paste Firebase config here, e.g.:
{
  "apiKey": "...",
  "projectId": "...",
  "storageBucket": "..."
}' style="width: calc(100% - 20px); height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 12px; resize: vertical;"></textarea>
      <button onclick="parseConfig()" style="margin-top: 5px; background: #6c757d;">Parse & Fill</button>
    </div>
    <div style="border-top: 1px solid #ddd; padding-top: 15px; margin-top: 15px;">
      <label style="display: block; margin-bottom: 5px; font-size: 14px; color: #666;">Or fill individually:</label>
      <input type="text" id="apiKey" placeholder="API Key">
      <input type="text" id="projectId" placeholder="Project ID">
      <input type="text" id="storageBucket" placeholder="Storage Bucket">
    </div>
    <button onclick="saveFirebaseConfig()">Save Config</button>
  </div>

  <div class="setting">
    <h3>Sync Folder</h3>
    <div id="currentFolder" class="status">No folder selected</div>
    <button onclick="selectFolder()">Select Folder</button>
  </div>

  <div class="setting">
    <h3>Sync Status</h3>
    <div id="syncStatus" class="status">Not syncing</div>
    <div class="button-group">
      <button id="toggleSync" onclick="toggleSync()">Start Sync</button>
    </div>
  </div>

  <script>
    // Load existing config on startup
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        const config = await window.electronAPI.getConfig();

        if (config.firebase) {
          document.getElementById('apiKey').value = config.firebase.apiKey || '';
          document.getElementById('projectId').value = config.firebase.projectId || '';
          document.getElementById('storageBucket').value = config.firebase.storageBucket || '';
        }

        if (config.syncFolder) {
          document.getElementById('currentFolder').textContent = config.syncFolder;
          document.getElementById('currentFolder').classList.add('success');
        }
      } catch (error) {
        console.error('Error loading config:', error);
      }
    });

    function parseConfig() {
      try {
        let jsonText = document.getElementById('configJson').value.trim();
        if (!jsonText) return;

        // Make it super lenient - handle ANY JavaScript syntax
        // Remove any variable declaration (const/var/let/export const/etc)
        jsonText = jsonText.replace(/^(export\s+)?(const|var|let)\s+\w+\s*=\s*/, '');

        // Remove trailing semicolons
        jsonText = jsonText.replace(/;+\s*$/, '');

        // Remove comments
        jsonText = jsonText.replace(/\/\/.*$/gm, '');
        jsonText = jsonText.replace(/\/\*[\s\S]*?\*\//g, '');

        // Try to parse - use eval for maximum compatibility
        let config;
        try {
          config = JSON.parse(jsonText);
        } catch {
          config = eval('(' + jsonText + ')');
        }

        // Fill in whatever fields exist
        if (config.apiKey !== undefined) document.getElementById('apiKey').value = config.apiKey;
        if (config.projectId !== undefined) document.getElementById('projectId').value = config.projectId;
        if (config.storageBucket !== undefined) document.getElementById('storageBucket').value = config.storageBucket;

        // Clear the textarea
        document.getElementById('configJson').value = '';
      } catch (error) {
        console.error('Parse error:', error);
      }
    }

    async function selectFolder() {
      try {
        const folder = await window.electronAPI.selectFolder();
        if (folder) {
          await window.electronAPI.saveSyncFolder(folder);
          document.getElementById('currentFolder').textContent = folder;
          document.getElementById('currentFolder').classList.add('success');
        }
      } catch (error) {
        console.error('Error selecting folder:', error);
        alert('Error selecting folder: ' + error.message);
      }
    }

    async function saveFirebaseConfig() {
      try {
        const config = {
          apiKey: document.getElementById('apiKey').value.trim(),
          projectId: document.getElementById('projectId').value.trim(),
          storageBucket: document.getElementById('storageBucket').value.trim()
        };

        if (!config.apiKey || !config.projectId || !config.storageBucket) {
          alert('Please fill in all Firebase configuration fields');
          return;
        }

        await window.electronAPI.saveFirebaseConfig(config);
        alert('Firebase configuration saved!');
      } catch (error) {
        console.error('Error saving Firebase config:', error);
        alert('Error saving config: ' + error.message);
      }
    }

    async function toggleSync() {
      const btn = document.getElementById('toggleSync');
      const status = document.getElementById('syncStatus');

      try {
        if (btn.textContent === 'Start Sync') {
          btn.disabled = true;
          const result = await window.electronAPI.startSync();
          btn.disabled = false;

          console.log('[UI] Start sync result:', result);

          // Check if there was an error
          if (result.startsWith('Error')) {
            status.textContent = result;
            status.classList.remove('success');
            status.classList.add('error');
            alert(result);
          } else if (result === 'Sync is already running') {
            status.textContent = result;
            btn.textContent = 'Stop Sync';
          } else {
            // Success
            btn.textContent = 'Stop Sync';
            status.textContent = 'Syncing... (check terminal for logs)';
            status.classList.add('success');
            status.classList.remove('error');
          }
        } else {
          btn.disabled = true;
          const result = await window.electronAPI.stopSync();
          btn.disabled = false;

          console.log('[UI] Stop sync result:', result);

          btn.textContent = 'Start Sync';
          status.textContent = result || 'Not syncing';
          status.classList.remove('success');
          status.classList.remove('error');
        }
      } catch (error) {
        console.error('Error toggling sync:', error);
        alert('Error: ' + error.message);
        btn.disabled = false;
        status.classList.add('error');
      }
    }
  </script>
</body>
</html>
